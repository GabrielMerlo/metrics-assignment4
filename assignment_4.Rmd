---
title: |
  | Assignment 4 
  | Econometrics I
subtitle: "Universidad Carlos III de Madrid"
author: "Gabriel Merlo"
date:
header-includes: 
  - \usepackage{float}
      \floatplacement{figure}{H}
output: pdf_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = "center")
```

```{r include_packages, results = "hide"}
# install packages (if missing)
list_packages <- c("dplyr", "MatchIt", "tidyr")
new_packages <- list_packages[!(list_packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)

# Load packages
sapply(list_packages, require, character.only = TRUE)
```


```{r include_packages, results = "hide"}
```

# Exercise 1

## (a) Read the data and estimate the ATE using the standard difference of sample means and a linear regression using as controls X.

` ` 

```{r 1a, tidy = TRUE, tidy.opts = list(width.cutoff = 80)}
# Load data
penn <- as.data.frame(read.table("penn_jae.dat", header = TRUE))

# Keep control group, and treatment group 4
penn4 <- penn %>% filter(tg == 0 | tg == 4)

# Recode treatment variable
penn4$tg <- recode(penn4$tg, `4` = 1L) 

# Control variables
x <- c("female", "black", "othrace", "dep", "q2", "q3", "q4", "q5", "q6", "agelt35", "agegt54", "durable", "lusd", "husd")

# Log transformation of dependent variable
penn4$l_inuidur1 <- log(penn4$inuidur1)

# ATE from difference of sample means
diff_mean <- penn4 %>% 
  group_by(tg) %>% 
  summarize(mean = mean(l_inuidur1)) %>%
  spread(tg, mean) %>% 
  summarize(diff = `1` - `0`)
diff_mean

# ATE from linear regression with controls
ate <- lm(as.formula(paste("l_inuidur1 ~ tg +", paste(x, collapse = "+"))), data = penn4)
summary(ate)

# Checking balance of covariates
penn4 %>%
  group_by(tg) %>%
  select(x) %>%
  summarise_all(funs(mean(.)))
```

` `

The difference in the mean of log of duration of unemployment between treated and control groups is `r round(diff_mean, 2)`. This implies that those that receive the treatment spend less time being unemployed than those who don't get the treatment. 

Controlling by observable characteristics of the individuals, the log of duration of unemployment is `r round(abs(ate$coefficients[2]), 2)` smaller for the individuals that receive the treatment. Once we control by our vector of observables `x`, the effect of the treatment is `r round(abs(diff_mean) - abs(ate$coefficients[2]), 2)` smaller than when comparing using the difference of means (without controls). 

Ideally, randomization should balance the distribution of covariates among treated and untreated. One way to check if this is true is by calculating the sample mean difference in covariates between treatment and control groups. The balance is in general quite good but some characteristics are still not very well balanced (we could test if the differences are significant). This can explain the difference in the ATE by the two previous methods.

` `

## (b) One way to evaluate if the randomization is sucessful is to test the significance of $\theta_0$ in a Probit specification of the propensity score $p(x)=\Phi(x'\theta_0)$. Run such a test and interpret the results. Discuss the type of test, critical value, etc.

` `

Randomization is used to assure that the participation in the treatment is the only differentiating factor between individuals in both groups. Propensity score matching can be used to evaluate if the randomization process was correctly done by comparing the outcome variable for similar individuals in the treatment group and the ones in the control group. 

Matching propensity scores allows to compare similar individuals in and outside the treatment group. By calculating the probability of participation, matching individuals with same probability but in different groups can be used to calculate ATE. However, two assuptions are used in this case: 

1- Bias is only on observables. 
2- Treatment and control groups have a common support. 

The second assumption can be solved by restricting the sample to a common support. We will use the `MatchIt` package to do the propensity score matching. The algorithm method selected for matching is the nearest neighbor method (it matches individuals with the closest propensity score from the other group).

```{r 1_b}
# Match observations
match <- matchit(
  as.formula(paste("tg ~ ", paste(x, collapse = "+"))),
  method = "nearest", 
  link = "probit", 
  replace = TRUE,
  data = penn4)
summary(match)

# Dataframe with only matched observations
penn4m <- match.data(match)
dim(penn4m)

# ATE from difference of sample means from matched data
diff_mean_matched <- penn4m %>% 
  group_by(tg) %>% 
  summarize(mean = mean(l_inuidur1)) %>%
  spread(tg, mean) %>% 
  summarize(diff = `1` - `0`)
diff_mean_matched
```

